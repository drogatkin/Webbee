<?xml version="1.0" encoding="utf-8"?>
 <!DOCTYPE bee PUBLIC "-//Dmitriy Rogatkin//DTD Bee Project Builder 1.0//EN"
    "http://knitknot.info/DTD/bee.dtd" [
      <!ENTITY env SYSTEM "./env.xml">
      <!ENTITY project "webbee">
      <!ENTITY build_directory "build/out">
      <!ENTITY source_directory "src/java"> <!-- change if differs -->
      <!ENTITY build_file "&project;.jar"> <!-- change if differs -->
      <!ENTITY domain "com">
      <!ENTITY manifestf "">
      <!ENTITY main_class "">
      <!ENTITY webapp_file "&project;.war"> <!-- change if differs -->
      ]>
<!-- $Id: bee.xml,v 1.10 2012/04/17 22:04:56 dmitriy Exp $
   Build script file used for "WebBee" project
   Copyright (c) 2008-2010 Dmitriy Rogatkin    -->

<bee name="&project;" type="project" dir="..">
  &env;

  <expression variable="javac">
     <operator name="append">
        <value variable="JAVA_HOME"/>
        <value>/bin/javac</value>
     </operator>
  </expression>

  <target name="create" dir="..">
     <dependency>true</dependency>
     <block>
       <echo>Welcome to new project creation wizard</echo>
       <variable name="projects root"/>
       <expression name="projects root">
          <operator name="append">
             <function name="ask">
                 <parameter>Enter projects root directory [../..]?</parameter>
                 <parameter type="path">../../</parameter>
             </function>
           </operator> 
       </expression>
       <expression name="project name">
           <function name="ask">
                 <parameter>Enter projects name [test]?</parameter>
                 <parameter>test</parameter>
           </function>
       </expression>
       <expression name="C project name">
           <function name="string">
                 <parameter variable="project name"/>
                 <parameter>capital</parameter>
           </function>
       </expression>

       <expression name="org name">
           <function name="ask">
                 <parameter>Enter your organization name [acme]?</parameter>
                 <parameter>test</parameter>
           </function>
       </expression>
       <expression name="project directory">
          <operator name="append">
             <value variable="projects root"/>
             <value>/</value>
             <value variable="project name"/>
          </operator>
       </expression>       
       <function name="mkd">
          <parameter variable="project directory"/>
       </function>
       <variable name="project folders">build,doc,src,src/res,src/res/cfg,src/res/css,src/res/html,src/res/image,src/res/text,src/res/view,src/java,src/js</variable>
       <for variable="folder" in="project folders" separator=",">
         <block>
           <expression name="target folder">
              <operator name="append">
                 <value variable="project directory"/>
                 <value>/</value>
                 <value variable="folder"/>
              </operator>
           </expression> 
           <!--echo variable="target folder"/-->
           <function name="mkd">
              <parameter variable="target folder"/>
           </function>
          </block>
       </for>
       <expression name="project domain">
           <function name="ask">
                 <parameter>Enter projects domain [com]?</parameter>
                 <parameter>com</parameter>
           </function>
       </expression>
       <expression name="db code">
           <function name="ask">
                 <parameter>Database type used, one of h2, ora, my, hado, none [ora]?</parameter>
                 <parameter>ora</parameter>
           </function>
       </expression>
       <expression name="class folders">
         <operator name="append">
             <value value="ux,model,model/util,serv"/>             
         </operator>
       </expression>

       <for variable="folder" in="class folders" separator=",">
         <block>
           <expression name="target folder">
              <operator name="append">
                 <value variable="project directory"/>
                 <value>/</value>
                 <value value="src/java/"/>
                 <value variable="project domain"/>
                 <value>/</value>
                 <value variable="org name"/>
                 <value>/</value>
                 <value variable="project name"/>
                 <value>/</value>
                 <value variable="folder"/>
              </operator>
           </expression> 
           <!--echo variable="target folder"/-->
           <function name="mkd">
              <parameter variable="target folder"/>
           </function>
          </block>
       </for>
       <expression name="wrk file">
          <operator name="append">
                 <value variable="project directory"/>
                 <value>/sequence.cnt</value>
          </operator>
       </expression>
       <function name="write">
          <parameter variable="wrk file"/>
          <parameter>1</parameter>
       </function>

       <expression variable="model class">
           <operator name="append">
             <value>
// Webbee (C) 2015 Dmitriy Rogatkin
///////   application model file   //////////
// TODO modify the file for the application purpose
package </value>
             <value variable="project domain"/>
             <value>.</value>
             <value variable="org name"/>
             <value>.</value>
             <value variable="project name"/>
             <value>.model;
</value>
             <value>
import javax.sql.DataSource;
import org.aldan3.data.DOService;
import org.aldan3.model.Log;

import com.beegman.webbee.model.AppModel;
//import com.beegman.webbee.model.Auth;

public class </value>
             <value variable="C project name"/>
             <value>Model extends AppModel {

	@Override
	public String getAppName() {
		return "</value>
             <value variable="project name"/>
             <value>";
	}
	
	@Override
	protected String getServletName() {
		return "Webbee servlet";
	}
 
	@Override
	protected DOService createDataService(DataSource datasource) {
		return new DOService(datasource) {
                };
        }

	@Override
	protected void initServices() {
		super.initServices();
	}
}</value>         
           </operator>
       </expression>
       
       <expression name="wrk file">
          <operator name="append">
                 <value variable="project directory"/>
                 <value>/</value>
                 <value value="src/java/"/>
                 <value variable="project domain"/>
                 <value>/</value>
                 <value variable="org name"/>
                 <value>/</value>
                 <value variable="project name"/>
                 <value>/model/</value>
                 <value variable="C project name"/>
                 <value>Model.java</value>
          </operator>
       </expression>
       <function name="write">
         <parameter variable="wrk file"/>
         <parameter variable="model class"/>
       </function>
       <expression name="wrk file">
          <operator name="append">
                 <value variable="project directory"/>
                 <value>/</value>
                 <value value="src/cfg/"/>
                 <value variable="project name"/>
                 <value>.properties</value>
         </operator>
       </expression>
       <function name="write">
         <parameter variable="wrk file"/>
         <parameter>
#
PresentServicePackage=</parameter>
         <parameter variable="project domain"/>
         <parameter>.</parameter>
         <parameter variable="org name"/>
         <parameter>.</parameter>
         <parameter variable="project name"/>
         <parameter>.ux.

RESOURCEROOT=/WEB-INF/res/text

TEMPLATEROOT=/WEB-INF/res/view

viewext=.html

#stationary=

#copyright=

#public_home=

#attach_home=

#public_canvas=

#mobile_support=yes

DEBUG=1
</parameter>
       </function>
       <expression name="wrk file">
          <operator name="append">
                 <value variable="project directory"/>
                 <value>/</value>
                 <value value="src/cfg/web.xml"/>
          </operator>
       </expression>
       <function name="write">
         <parameter variable="wrk file"/>
         <parameter>&lt;web-app version="3.0" xmlns="http://java.sun.com/xml/ns/javaee"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
	metadata-complete="true"&gt;

	&lt;context-param&gt;
		&lt;param-name&gt;model_datasource&lt;/param-name&gt;
		&lt;param-value>jdbc/</parameter>
        <parameter variable="db code"/>
        <parameter>/</parameter>
        <parameter variable="project name"/>
        <parameter>&lt;/param-value&gt;
	&lt;/context-param&gt;
	&lt;listener&gt;
		&lt;listener-class></parameter>
          <parameter variable="project domain"/>
          <parameter>.</parameter>
          <parameter variable="org name"/>
          <parameter>.</parameter>
          <parameter variable="project name"/>
          <parameter>.model.</parameter>
          <parameter variable="C project name"/>
          <parameter>Model&lt;/listener-class&gt;
	&lt;/listener&gt;
	&lt;servlet&gt;
                &lt;servlet-name&gt;Webbee servlet&lt;/servlet-name&gt;
		&lt;description&gt;Webbee main servlet&lt;/description&gt;
		&lt;servlet-class&gt;com.beegman.webbee.base.WebApp&lt;/servlet-class&gt;
		&lt;init-param>
			&lt;param-name&gt;properties&lt;/param-name&gt;
			&lt;param-value&gt;/WEB-INF/config/</parameter>
          <parameter variable="project name"/>
          <parameter>.properties&lt;/param-value&gt;
		&lt;/init-param&gt;
		&lt;async-supported>true&lt;/async-supported&gt;
	&lt;/servlet&gt;
	&lt;servlet-mapping&gt;
		&lt;servlet-name&gt;Webbee servlet&lt;/servlet-name&gt;
		&lt;url-pattern&gt;/webbee/*&lt;/url-pattern&gt;
	&lt;/servlet-mapping&gt;
	&lt;welcome-file-list&gt;
		&lt;welcome-file&gt;index.html&lt;/welcome-file&gt;
	&lt;/welcome-file-list&gt;
	&lt;resource-ref&gt;
		&lt;res-ref-name&gt;java:comp/env/jdbc/</parameter>
        <parameter variable="db code"/>
        <parameter>/</parameter>
        <parameter variable="project name"/>
        <parameter>&lt;/res-ref-name&gt;
		&lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
		&lt;res-auth&gt;Container&lt;/res-auth&gt;
	&lt;/resource-ref&gt;
&lt;/web-app&gt;
           </parameter>
        </function>
       <expression name="wrk file">
          <operator name="append">
                 <value variable="project directory"/>
                 <value>/</value>
                 <value value="bee.xml"/>
          </operator>
       </expression>

       <variable name="conf header">&lt;?xml version="1.0"?&gt;
 &lt;!DOCTYPE bee PUBLIC "-//Dmitriy Rogatkin//DTD Bee Project Builder 1.0//EN"
    "http://knitknot.info/DTD/bee.dtd" [
      &lt;!ENTITY env SYSTEM "./env.xml"&gt;
      &lt;!ENTITY project "</variable>
       <expression variable="conf header">
          <operator name="append">
             <value variable="conf header"/>
             <value variable="project name"/>
             <value>"&gt;
      &lt;!ENTITY build_directory "./build"&gt;
      &lt;!ENTITY source_directory "src/java"&gt;
      &lt;!ENTITY build_file "&amp;project;.jar"&gt; 
      &lt;!ENTITY domain "</value>
             <value variable="project domain"/>
             <value>"&gt;
      &lt;!ENTITY org "</value>
             <value variable="org name"/>
             <value>"&gt;
      &lt;!ENTITY manifestf ""&gt;
      &lt;!ENTITY wizard SYSTEM "file:/</value> 
             <value variable="WEBBEE_HOME"/>
             <value>/build/wizard.xml"&gt;
      &lt;!ENTITY main_class "&amp;domain;.&amp;org;.&amp;project;.Main"&gt;
      &lt;!ENTITY webapp_file "&amp;project;.war"&gt; 
      &lt;!ENTITY projects_root "</value>
            <value variable=""/>
            <value>"&gt;
      ]>
</value>
         </operator>
       </expression>
       <function name="write">
           <parameter variable="wrk file"/>
           <parameter variable="conf header"/>
       </function>
       <function name="cpa">
           <parameter type="dir">bee.proj.tmpl</parameter>
           <parameter variable="wrk file"/>
       </function>
       <expression name="wrk file">
          <operator name="append">
                 <value variable="project directory"/>
                 <value>/</value>
                 <value value="env.xml"/>
          </operator>
       </expression>
       <function name="write">
           <parameter variable="wrk file"/>
           <parameter>   &lt;variable name="WEBBEE_HOME" type="path"&gt;</parameter>
           <parameter variable="WEBBEE_HOME"/>
           <parameter>&lt;/variable&gt;
   &lt;variable name="ALDAN3_HOME" type="path"&gt;</parameter>
           <parameter variable="ALDAN3_HOME"/>
           <parameter>&lt;/variable&gt;

</parameter>
       </function>
       <function name="cpa">
           <parameter type="path">build/env.proj.tmpl</parameter>
           <parameter variable="wrk file"/>        
      </function>

     </block>
  </target>

  <target name="check build" dir="WEBBEE_HOME">
     <dependency>
        <expression>
          <operator name="eq">
            <function name ="timestamp">
               <parameter value="&build_directory;" type="path"/>
            </function>
            <value></value>
          </operator>
        </expression>
     </dependency>
     <block>
       <function name="mkd">
         <parameter value="&build_directory;" type="path"/>
       </function>
     </block>
  </target>

  <!-- reconsider in case of not project root build script -->
  <expression variable="java sources">
        <function name="newerwithdependency">
           <parameter value="&source_directory;/&domain;/.java" type="path"/>
           <parameter value="&build_directory;/&domain;/.class" type="path"/>
	   <parameter/>
	   <parameter value="&domain;"/>
        </function>
  </expression>

  <expression variable="class path">
     <operator name="append">
        <value variable="WEBBEE_HOME"/>
        <value>/&build_directory;</value>
        <value variable="PATH SEPARATOR"/>
        <value variable="CUSTOM CP"/>
     </operator>
  </expression>

  <target name="compile" dir="WEBBEE_HOME">
    <dependency target="check build"/>
    <dependency variable="java sources"/>
    <echo>Compiling...</echo>
    <task exec="javac">
       <parameter value="-classpath"/>
       <parameter variable="class path"/>
       <parameter value="-source"/>
       <parameter value="1.5"/>
       <parameter value="-target"/>
       <parameter variable="comp target"/>
       <parameter value="-d"/>comp target
       <parameter value="&build_directory;" type="path"/>
       <parameter variable="java sources"/>>
      <onexit>
        <if>
          <expression>
             <operator name="neq"><value variable="resultcode"/><value>0</value></operator>
          </expression>
          <block type="then">
                 <echo>Error(s) at compilation</echo>
                 <function name="stop">
			<parameter value="1"/>
                 </function>
          </block>
       </if>
      </onexit>
      <onexception>
	<block>
                 <echo>Exception at compilation</echo>
                 <function name="stop">
			<parameter value="-1"/>
                 </function>
	</block>
      </onexception>
    </task>
  </target>

  <expression variable="manifest file">
     <value type="path">&manifestf;</value>
  </expression>

  <target name="jar" dir="WEBBEE_HOME">
    <echo>Jarring...</echo>
    <dependency target="compile"/>
    <dependency>
           <function name="allnewer">
              <parameter value="&build_directory;/&domain;" type="dir"/>
              <parameter value="&build_directory;/&build_file;" type="path"/>
           </function>
    </dependency>
    <dependency>
           <function name="allnewer">
              <parameter value="bee.xml" type="dir"/>
              <parameter value="&build_directory;/&build_file;" type="path"/>
           </function>
    </dependency>

    <task name="jar_do" code="sun.tools.jar.Main">
       <parameter>
          <expression>
            <if>
              <expression>
                <operator name="eq">
                  <value/>
                  <value variable="manifest file"/>
                </operator>
              </expression>
              <block type="then">
                <value>-cf</value>
              </block>
              <block type="else">
                <operator name="array">
	           <value>-cmf</value>
                   <value variable="manifest file"/>
                 </operator>
              </block>
            </if>
          </expression>
       </parameter>   
       <parameter value="&build_directory;/&build_file;" type="path"/>
       <parameter value="-C"/>
       <parameter value="&build_directory;" type="path"/>
       <parameter value="&domain;"/>
      <onexception>
	<block>
                 <echo>Exception at jarring</echo>
                 <function name="stop">
			<parameter value="-1"/>
                 </function>
	</block>
      </onexception>
    </task>
  </target>

  <target name="clean" dir="WEBBEE_HOME">
    <dependency>
       <expression>
         <operator name="eq">
            <value>y</value>  
            <function name="ask">
               <parameter value="Are you sure to remove all files in &build_directory; [n]?"/>
               <parameter value="n"/>
            </function>
        </operator>
      </expression>
    </dependency>
    <block>
      <echo>Cleaning...</echo>
      <function name="rm">
         <parameter value="&build_directory;/*/*//*/*/*.class" type="path"/>
         <parameter value="&build_directory;/&build_file;" type="path"/>
         <parameter value="&build_directory;/&webapp_file;" type="path"/>
      </function>
    </block>
  </target>

  <expression variable="rt class path">
     <operator name="append">
        <value variable="class path"/>
        <value variable="PATH SEPARATOR"/>
        <value value="&build_directory;/&build_file;" type="path"/>
    </operator>
  </expression>

  <target name="tools" dir="WEBBEE_HOME">
    <dependency target="war"/>
    <dependency>true</dependency>
    <task name="main" code="com.beegman.webbee.tool.ConvTool" path="rt class path">
       <parameter variable="~#args#~"/>
    </task>
  </target>



  <expression variable="appserver class path">
     <operator name="append">
        <value variable="TJWS_HOME"/>
        <value>/lib/webserver.jar</value>
        <value variable="PATH SEPARATOR"/>
        <value variable="TJWS_HOME"/>
        <value>/lib/war.jar</value>
        <value variable="PATH SEPARATOR"/>
        <value variable="TJWS_HOME"/>
        <value>/lib/app.jar</value>
        <value variable="PATH SEPARATOR"/>
        <value variable="SERVLET_LIB"/>
     </operator>
  </expression>

  <target name="run" dir="WEBBEE_HOME">
    <echo>Running web app &project; ...</echo>
    <dependency target="war"/>
    <dependency value="true"/>
    <task name="main" code="rogatkin.app.Main" path="appserver class path">
       <parameter name="rogatkin.web.WebAppServlet.debug" value="yes"/>
       <parameter name="tjws.webappdir" value="&build_directory;" type="path"/>
       <parameter name="java.awt.headless" value="true"/>
       <parameter name="tjws.wardeploy.dynamically" value="10"/>
       <parameter>-dataSource</parameter>
       <parameter type="path">src/res/cfg/datasource.properties</parameter>
       <parameter value="-p"/>
       <parameter>
         <expression>
           <if>
             <expression>
               <value name="secure" type="property"/>
             </expression>
             <block type="then">
                <variable name="port" value="443"/>
             </block>
             <block type="else">
                <variable name="port">80</variable>
             </block>
           </if>
         </expression>
       </parameter>
       <parameter value="-l"/>
       <parameter>
          <expression variable="secure socket">
           <if>
             <expression>
               <value name="secure" type="property"/>
             </expression>
             <block type="then">
                <expression variable="secure socket">
                  <operator name="array">
                      <value>-acceptorImpl</value>
                      <value>Acme.Serve.SSLAcceptor</value>
                      <value>-keystorePass</value>
                      <value variable="key pass"/>
                  </operator>
                </expression>
             </block>
           </if>
         </expression>
      </parameter>
      <parameter value="-j"/>
      <parameter value="org.apache.jasper.servlet.JspServlet"/>
      <parameter value="-org.apache.jasper.servlet.JspServlet.classpath"/>
      <parameter value="%classpath%"/>
      <parameter value="-org.apache.jasper.servlet.JspServlet.scratchdir"/>
      <parameter value="%deploydir%/WEB-INF"/>
    </task>
  </target>  

  <expression name="ALDAN3_LIB">
     <operator name="append">
        <value variable="ALDAN3_HOME"/>
        <value>/build/aldan3.jar</value>
     </operator>
  </expression>

  <target name="war" dir="WEBBEE_HOME">
    <dependency target="jar"/>
    <dependency>
       <expression>
          <operator name="not">
             <function name ="timestamp">
                <parameter value="&build_directory;/&webapp_file;" type="path"/>
             </function>
          </operator>
       </expression>
    </dependency>
    <dependency>
       <expression>
          <operator name="or">
             <function name="anynewer">
                <parameter variable="src/res/html" type="path"/>
                <parameter value="&build_directory;/&webapp_file;" type="path"/>
             </function>
             <function name="anynewer">
                <parameter value="src/res/cfg" type="path"/>
                <parameter value="&build_directory;/&webapp_file;" type="path"/>
             </function>
          </operator>
       </expression>
    </dependency>
    <dependency>
       <expression>
          <function name="anynewer">
             <parameter value="src/res/template/insert" type="path"/>
             <parameter value="&build_directory;/&webapp_file;" type="path"/>
          </function>
       </expression>
    </dependency>
    <dependency>
       <expression>
          <function name="anynewer">
             <parameter value="src/res/template" type="path"/>
             <parameter value="&build_directory;/&webapp_file;" type="path"/>
          </function>
       </expression>
    </dependency>
    <dependency>
       <expression>
          <function name="anynewer">
             <parameter value="src/res/css" type="path"/>
             <parameter value="&build_directory;/&webapp_file;" type="path"/>
          </function>
       </expression>
    </dependency>
    <dependency>
       <expression>
          <function name="anynewer">
             <parameter value="src/res/image" type="path"/>
             <parameter value="&build_directory;/&webapp_file;" type="path"/>
          </function>
       </expression>
    </dependency>
    <dependency>
       <expression>
          <function name="anynewer">
             <parameter value="src/res/text" type="path"/>
             <parameter value="&build_directory;/&webapp_file;" type="path"/>
          </function>
       </expression>
    </dependency>
    <dependency>
       <expression>
          <function name="anynewer">
             <parameter variable="ALDAN3_LIB" type="path"/>
             <parameter value="&build_directory;/&webapp_file;" type="path"/>
          </function>
       </expression>
    </dependency>
    <block>
      <echo value="...->&build_directory;/&webapp_file;"/>
      <function name="warit">
         <parameter value="&build_directory;/&webapp_file;" type="path"/>
         <parameter type="path">src/res/cfg/web.xml</parameter>
         <parameter>C &domain;</parameter>
         <parameter type="path">&build_directory;/&domain;</parameter>
         <parameter/>
         <parameter>L</parameter>
         <parameter variable="CUSTOM CP" type="array" separator="PATH SEPARATOR"/>
         <parameter/>
         <parameter>A WEB-INF/config/</parameter>
         <parameter type="path">src/res/cfg/&project;.properties</parameter>
         <!-- template resources -->
         <parameter>A WEB-INF/res/template/insert</parameter>
         <parameter type="path">src/res/template/insert/*.htmt</parameter>
         <parameter>A WEB-INF/res/template/insert</parameter>
         <parameter type="path">src/res/template/insert/*.json</parameter>
         <parameter>A WEB-INF/res/template</parameter>
         <parameter type="path">src/res/template/*.htmt</parameter>
         <parameter>A WEB-INF/res/template/portlet</parameter>
         <parameter type="path">src/res/template/portlet/*.htmt</parameter>
         <!-- text/labels properties resources -->
         <parameter>E WEB-INF/res/text/</parameter>
         <parameter type="path">src/res/text/*.properties</parameter>
         <parameter>commonlabels.properties</parameter>
         <parameter>A WEB-INF/res/text/</parameter>
         <parameter type="path">src/res/text/commonlabels.properties</parameter>
         <parameter>A WEB-INF/res/text/data</parameter>
         <parameter type="path">src/res/text/data/*.properties</parameter>

         <!-- image resources -->
         <parameter>A image/</parameter>
         <parameter type="path">src/res/image/*.gif</parameter>
         <parameter>A image/</parameter>
         <parameter type="path">src/res/image/*.jpg</parameter>

         <parameter>A</parameter>
         <parameter type="path">src/res/html/*.html</parameter>
         <parameter>A css/</parameter>
         <parameter type="path">src/res/css/*.css</parameter>
         <parameter>A js/</parameter>
         <parameter type="path">src/js/*.js</parameter>
         <!-- 3rd parties (not yet) -->
         <parameter>A js/</parameter>
         <parameter type="path">src/3rdparty/htmlencoder/*.js</parameter>
         <!-- Prototype (not in use)  -->
      </function>
    </block>
  </target>
</bee>

